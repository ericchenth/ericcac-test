===== BGP Route Injector =====

==== What is it ? ====

Some code which :
  * Can inject routes with arbitrary next-hops into your network
  * Can act as an IBGP or EBGP speaker (but not listener)

==== Where can I get it ? ====

The code is stored in our SVN repository: \\
[[http://svn.exa.org.uk/bgp/trunk|http://svn.exa.org.uk/bgp/trunk]] \\
[[http://fisheye.exa.org.uk/browse/BGP/trunk|Fisheye browsing]]

Get it with
   cd /opt
   svn co -r 128 http://svn.exa.org.uk/bgp/trunk bgp

There is currently no tarball or official release yet.

However, we currently use revision 128 to:
  * source ASN112 servers
  * source some ipv4 /32
  * source some /128 (using both IPv4 and IPv6 TCP connections)

The code to reload the configuration and send the correct update on SIGHUP is currently untested - it may work, it may not (you can use graceful restart and simply kill the daemon to achieve a similar result).

==== How do you configure it ? ====

You provide the name of the configuration file as an argument to the program. For example:

   #!/bin/bash
   exec env PYTHONPATH=/opt/bgp/lib setuidgid nobody /opt/bgp/daemon/bgpd /opt/bgp/etc/bgp/as112.txt 2>&1

We are using [[http://cr.yp.to/daemontools.html|deamontools]] to run and supervise the application on crash, but we never saw it crash (touching wood).

As the application does not bind to port 179, or program the local routing table, it does not need any escalated privileges and will happily run as "nobody".

The configuration file is very juniper like :

IPv4 example

   neighbor 192.168.127.128 {
   	description "a quagga test peer";
   	router-id 192.168.127.1;
   	local-address 192.168.127.1;
   	local-as 65000;
   	peer-as 65534;
   	graceful-restart;
   
   	static {
   		route 10.0.1.0/24 {
   			next-hop 10.0.255.254;
   		}
   		route 10.0.2.0/24 {
   			next-hop 10.0.255.254;
   			community 30740:30740;
   		}
   		route 10.0.3.0/24 {
   			next-hop 10.0.255.254;
   			community [ 30740:30740 30740:0 ];
   		}
   		route 10.0.4.0/24 {
   			next-hop 10.0.255.254;
   			local-preference 200;
   		}
   		route 10.0.5.0/24 next-hop 10.0.255.254 local-preference 200;
   		route 10.0.6.0/24 next-hop 10.0.255.254 community 30740:30740;
   		route 10.0.7.0/24 next-hop 10.0.255.254 local-preference 200 community 30740:30740;
   		route 10.0.8.0/24 next-hop 10.0.255.254 community 30740:30740 local-preference 200;
   		route 10.0.7.0/24 next-hop 10.0.255.254 local-preference 200 community [30740:0 30740:30740];
   		route 10.0.8.0/24 next-hop 10.0.255.254 community [30740:0 30740:30740] local-preference 200;
   		route 10.0.5.0/24 next-hop 192.0.2.92 local-preference 10 community [ 0x87654321 ];
   	}
   }

IPv6 example

   neighbor 2a02:b80::2 {
   	description "a quagga test peer";
   	router-id 192.168.127.1;
   	local-address 2a02:b80::1;
   	local-as 65000;
   	peer-as 65534;
   	hold-time 180;
   	graceful-restart 1200;
   
   	static {
   		route 1.2.3.4/32 next-hop 5.6.7.8;
   		route 2A02:B80:0:1::1/64 next-hop 2A02:B80:0:2::1 community [30740:0 30740:30740] local-preference 200;
   	}
   }


==== Tell me more about the code ====

It is written in Python 2.x for version 2.5 or later. \\
No tests have been performed to check if it works with version 3.0.

The Python specificities of 2.5/2.6 have been removed from the code at commit 102 and 2.4 will let you setup bgp adjacencies but there are issues when it comes to dealing with BGP Notification Messages.

The code only relies on the standard library and has no external dependencies.
==== Anticipated Users FAQ ====

Q: Where is the documentation ? \\
A: Here and in the code .. really do you need more ??

Q: I am trying to connect to my router and it is not working \\
A: Did you enable multi-hop BGP on your router ?

Q: I am trying to send some IPv6 routes to my router but the connection never stays up \\
A: You may need to enable family inet6 for this peer. \\
A: juniper: set protocol bgp group <mygroup> neighbor <IP> family inet6 unicast \\
A: Do not forget to explicitly enable IPv4 as well if you are planning to send both v6 and v4 routes \\
A: juniper: set protocol bgp group <mygroup> neighbor <IP> family inet  unicast

Q: All seems fine but my route is not added to the routing table \\
A: You may need to allow for non-directly connected next-hop \\
A: juniper: set protocol bgp group <mygroup> neighbor <IP> accept-remote-nexthop

Q: I see I can specify the as-path (as-sequence) sent to the peer. Do you prepend the router ASN to EBGP peers ? \\
A: Yes and No :) \\
A: Should you not define an as-path for a EBGP connection, we will add the router ASN automatically \\
A: Otherwise you must add it yourself. \\
A: As we are not a real router, we let you do whatever you want.

Q: I see an IPv6 example, is it fully IPv6 enabled ? \\
A: The injector allows TCP IPv4 or IPv6 connections as well as supporting the exchange of both IPv4 and IPv6 routes.

Q: Can you maintain more than one BGP session? \\
A: Yes, you can define more than one neighbor in the configuration file

Q: Is this code supported ? \\
A: YES - Should you find any bug, please report it. 

Q: Are you planning to add more features ? (support for vpnv4,etc) \\
A: I will only really code new features for my own use, but feel free to send me patches.

Q: Why did you implement Graceful Restart ? \\
A: My use case are machines announcing service IPs without lower MED/Local Prefence backup machines ready to take the over in case of problems. The BGP IPs are then still routed during reboots and in case of very high load for example it will not render the service IP unreacheable if some keepalive are missed. \\
A: If no graceful-restart time is set, the waiting time is set to be the same as the hold-time. As servers often take much longer than the default 180 seconds to reboots, we recommend that you set the graceful-restart timer to a much higher value.

Q: I would like to inject routes in the network but my server is behind a NATing firewall, will it work ? \\
A: NAT is not a good idea but: Yes, it will work. \\
A: Set your local-address as your machine LAN IP and the router-id as the firewall public IP.

Q: Where do I report bugs - ask for help ?? \\
A: <sigh> ... contact me: thomas . mangin AT exa - networks . co . uk

==== Anticipated Coders FAQ ====

Q: As the code is single threaded, can a blocking network IO with one peer cause issues with another ? \\
A: We are using select to only read data when available on the socket but as we are not using a dedicated thread for keepalive, it could happen. \\
A: Should it be a major concern, run one instance of the program per peer.

Q: As you have no separate thread for keepalives, how many peers do you think one instance can manage comfortably? \\
A: it will really depend on the number of routes exchanged, but unless you speak to several dozen, have a very low keepalive time it should do fine for most use.

Q: I am a Ruby coder and I hate Python \\
A: use ByteMark [[https://projects.bytemark.co.uk/projects/bgpfeeder|BGPFeeder]] a very similar application 
   hg clone http://src.bytemark.co.uk/bgpfeeder

Q: I am a Perl coder and I hate Python \\
A: Use [[http://code.google.com/p/bgpsimple|bgpsimple]]
   svn checkout http://bgpsimple.googlecode.com/svn/trunk/ bgpsimple-read-only

Q: But there is [[https://code.launchpad.net/pybgp| already one in Python]] ! \\
A: I am not sure if this project existed when I started or not but I clearly missed it ! (and it does not support the MultiProtocol Extensions for IPv6 but instead for ipv4 and vpnv4/mpls which was not good for me :p)
   bzr branch lp:pybgp
